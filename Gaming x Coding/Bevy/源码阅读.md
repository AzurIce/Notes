## bevy_ecs

### Entity

`Entity` 就是一个 `index` Id + `generation` Id。

- `index`：bevy 中使用的 Id 十分简单，就是一个自增的整数加上一个回收 `Vec`。

    当 Entity 被移除时，其 `index` 会被插入到回收 `Vec` 中，分配新的实体时会首先从回收 `Vec` 中尝试获取可用 Id，如无可用 Id 则再生成一个（也就是 entity 数量）

- `generation`：每当一个 Entity 被 despawn 的时候，generation  会增加（表示 index 重用的次数），最大到 `0x7FFF_FFFF`



### Entities

`Entities` 存储了一个 `World` 内部关于全部 `Entity` 的元信息

- `meta: Vec<EntityMeta>`：对应 index 的元信息

    包含 `location` 和 `generation`。

- `pending: Vec<u32>`：回收的 index
- `free_cursor: AtomicIdCursor`：

#### 实体分配 `alloc`

- 如果能从 `pending.pop()` 获取到可用 Id：

    将 `free_cursor` 重新设为 `pending.len()`。

- 如果不能：

    用 `self.meta.len()` 作为 Id。

    向 `meta` 中插入一个新的 `EntityMeta::Empty`。

令 `len` 加一。

#### 实体释放 `free`

首先获取对应 `entity` 的元信息 `meta`，如果不是同一个 generation 则跳过。

更新元信息 `meta`：

- 令 `generation` 自增一（涨到 `HIGH_MASK` 会 wrap 到最小）
- 令 `location` 为 `EntityMeta::EMPTY` 的 `location`

将 `entity` 的 `index` 插入到回收列表 `pending` 中，并更新 `free_cursor` 为新的 `pending.len()`。

令 `len` 减一。